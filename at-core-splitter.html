<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">

<dom-module id="at-core-splitter">
  <style>
    :host {
      display: block;
      width: 12px;
      background: #efefef url(handle.svg) no-repeat center;
      box-shadow: inset 0 0 2px 1px #ccc;
      cursor: col-resize;
    }

    :host(.horizontal) {
      width: auto;
      height: 12px;
      cursor: row-resize;
      background-image: url(handle-h.svg);
    }

    :host(:hover, :active) {
      background-color: #ddd;
    }
  </style>
  <template></template>
  <script>
    'use strict';
    Polymer({
      is: 'at-core-splitter',
      properties: {
        /**
         * Possible values are `left`, `right`, `up` and `down`.
         *
         * @attribute direction
         * @type string
         * @default 'left'
         */
        direction: {
          type: String,
          value: 'left'
        },
        /**
         * Minimum width to which the splitter target can be sized, e.g.
         * `minSize="100px"`
         *
         * @attribute minSize
         * @type string
         * @default ''
         */
        minSize: {
          type: String,
          value: ''
        },
        /**
         * Locks the split bar so it can't be dragged.
         *
         * @attribute locked
         * @type boolean
         * @default false
         */
        locked: {
          type: Boolean,
          value: false
        },
        /**
         * By default the parent and siblings of the splitter are set to overflow hidden. This helps
         * avoid elements bleeding outside the splitter regions. Set this property to true to allow
         * these elements to overflow.
         *
         * @attribute allowOverflow
         * @type boolean
         * @default false
         */
        allowOverflow: {
          type: Boolean,
          value: false
        },
      },
      _scopeCssViaAttr: true,
      listeners: {
        'track': 'onTrack',
        'down': 'preventSelection'
      },
      observers: [
        'targetChanged(target)'
      ],
      behaviors: [Polymer.IronResizableBehavior],
      // Listen for resize requests on parent, since splitter is peer to resizables
      resizerIsPeer: true,
      ready: function() {
        this.directionChanged();
      },
      attached: function() {
        this.addEventListener('iron-resize', this.ironResizeHandler);
        this.async(function() {
          if (!this.allowOverflow) {
            this.parentNode.style.overflow = this.nextElementSibling.style.overflow =
              this.previousElementSibling.style.overflow = 'hidden';
          }
        });
      },
      detached: function() {
        this.removeEventListener('iron-resize', this.ironResizeHandler);
      },
      ironResizeHandler: function(event) {
        this.update();
      },
      directionChanged: function() {
        this.isNext = this.direction === 'right' || this.direction === 'down';
        this.horizontal = this.direction === 'up' || this.direction === 'down';
        this.update();
      },
      update: function() {
        this.target = this.isNext ? this.nextElementSibling : this.previousElementSibling;
        this.dimension = this.horizontal ? 'height' : 'width';
        this.classList.toggle('horizontal', this.horizontal);
      },
      targetChanged: function(old) {
        if (old) {
          old.style[old.__splitterMinSize] = '';
        }
        var min = this.target.__splitterMinSize = this.horizontal ? 'minHeight' : 'minWidth';
        this.target.style[min] = this.minSize;
      },
      preventSelection: function(e) {
        e.preventDefault();
      },

      onTrack: function(event) {
        var data = event.detail;
        var state = data.state;

        switch (state) {
          case 'start':
            this.update();
            this.size = parseInt(getComputedStyle(this.target)[this.dimension]);

            break;
          case 'track':
            if (this.locked) {
              return;
            }
            var d = data[this.horizontal ? 'dy' : 'dx'];
            this.target.style[this.dimension] = this.size + (this.isNext ? -d : d) + 'px';
            this.notifyResize();

            break;
          case 'end':

            break;
        }
      }
    });
  </script>
</dom-module>
